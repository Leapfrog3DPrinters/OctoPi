#!/usr/bin/env bash
#set -x
echo "" > /dev/null

source /common.sh
install_chroot_fail_on_error_trap

mkdir /home/pi/.config -p
chown -hR pi:pi /home/pi/.config

apt-get update

echo "--- Installing desktop environment"

#apt-get install --yes raspberrypi-ui-mods lightdm pcmanfm xinit lxterminal xinput
apt-get install --yes xorg xinit xinput lightdm openbox plymouth xscreensaver udisks2 udevil dbus-x11 feh exfat-fuse --no-install-recommends

echo "--- Configuring desktop environment"

# Disable cursor
sed -i "s|^#xserver-command\(.*\)|xserver-command=X -nocursor|" /etc/lightdm/lightdm.conf

# Autologin user pi
sed -i "s|^#autologin-user\(.*\)|autologin-user=pi|" /etc/lightdm/lightdm.conf


echo "--- Setting up to boot to desktop"
systemctl set-default graphical.target

echo "--- Configuring automount"

# Configure automount directory
mkdir -p /media/pi
chown -R pi:pi /media/pi 
sed -i "s|^allowed_media_dirs\(.*\)|allowed_media_dirs = /media/\$USER|" /etc/udevil/udevil.conf

echo "--- Installing chromium"
apt-get install --yes chromium-browser

pushd /home/pi/.config
	mkdir chromium -p
	chown -hR pi:pi chromium
popd

echo "--- Disabling Bluetooth service"
systemctl disable bluetooth
systemctl disable hciuart