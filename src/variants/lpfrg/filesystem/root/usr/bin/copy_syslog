#!/bin/sh

ORIGINAL_LOGFILE=/var/log/syslog
ORIGINAL_LOGFILE_BACKUP=/var/log/syslog.bak
LOGDIR=/home/pi/.octoprint/logs
LOGFILE="$LOGDIR/syslog.log"
TEMP_LOGFILE="$LOGDIR"/syslog-temp.log
RECORDS_TO_KEEP=3000

if [ ! -d "$LOGDIR" ]; then
	mkdir -p $LOGDIR
	chown -R pi:pi /home/pi/.octoprint
fi

# If the new logfile exists, keep the last n records and store them in a temporary file
if [ -f $LOGFILE ]; then
  tail -n $RECORDS_TO_KEEP $LOGFILE > $TEMP_LOGFILE
fi

if [ -f $ORIGINAL_LOGFILE ]; then
  # Add the contents of the syslog file to the temporary logfile
  cat $ORIGINAL_LOGFILE >> $TEMP_LOGFILE
  # Rename the original logfile, to prevent it from being copied twice
  mv -f $ORIGINAL_LOGFILE $ORIGINAL_LOGFILE_BACKUP
fi

# Rename the temporary logfile to the new logfile
mv -f $TEMP_LOGFILE $LOGFILE
chown pi:pi $LOGFILE

exit 0